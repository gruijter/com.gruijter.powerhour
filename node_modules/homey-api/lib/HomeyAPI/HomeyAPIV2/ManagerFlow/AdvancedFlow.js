'use strict';

const AdvancedFlowV3 = require('../../HomeyAPIV3/ManagerFlow/AdvancedFlow');

class AdvancedFlow extends AdvancedFlowV3 {
  static transformGet(item) {
    if (item.cards) {
      for (const card of Object.values(item.cards)) {
        if (card.type !== 'trigger' && card.type !== 'condition' && card.type !== 'action') {
          continue;
        }

        card.id = `${card.ownerUri}:${card.id}`;
      }
    }

    delete item.broken;

    return item;
  }

  static transformSet(item) {
    const nextItem = {
      ...item,
    };

    if (nextItem.cards) {
      nextItem.cards = { ...nextItem.cards };

      for (const [key, card] of Object.entries(nextItem.cards)) {
        if (card.type !== 'trigger' && card.type !== 'condition' && card.type !== 'action') {
          continue;
        }

        nextItem.cards[key] = {
          ...card,
          ownerUri: card.id.split(':', 3).join(':'),
          id: card.id.split(':').slice(3).join(':'),
        };
      }
    }

    return nextItem;
  }
}

module.exports = AdvancedFlow;
